services:
  backend:
    image: python:3.12-slim
    working_dir: /app
    env_file:
      - ./backend/.env
    volumes:
      - .:/app
    command: sh -c "cd backend && pip install -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 3001 --reload"
    ports:
      - '${BACKEND_HOST_PORT:-3001}:3001'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:3001/health')"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s

  frontend:
    image: node:22-alpine
    working_dir: /app
    env_file:
      - ./frontend/.env.local
    volumes:
      - .:/app
    command: sh -c "cd frontend && npm install && npm run dev -- --hostname 0.0.0.0 --port 3000"
    environment:
      NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-http://localhost:${BACKEND_HOST_PORT:-3001}}
      NEXT_PUBLIC_BACKEND_WS_URL: ${NEXT_PUBLIC_BACKEND_WS_URL:-ws://localhost:${BACKEND_HOST_PORT:-3001}}
    ports:
      - '${FRONTEND_HOST_PORT:-3000}:3000'
    depends_on:
      backend:
        condition: service_healthy
